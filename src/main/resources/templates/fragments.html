<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:fragment="head">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>sonakbi</title>
    <!--<link rel="stylesheet" th:href="@{/css/tailwind-out.css}" />-->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:300,400,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/node_modules/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/tui-editor/latest/tui-editor-contents.css" />
    <link rel="stylesheet" href="/node_modules/@yaireo/tagify/dist/tagify.css"/>

    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script src="/node_modules/@yaireo/tagify/dist/tagify.js"></script>

    <style>
        .container {
            max-width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }

        body, html {
            width: 100%;
            height: 100%;
        }

        a {
            text-decoration: none !important;
        }

        a.form-text:hover {
            text-decoration: underline !important;
        }

        ul {
            padding-left: 0 !important;
        }

        ul li {
            list-style-type: none;
        }

        body,
        input,
        button,
        select,
        optgroup,
        textarea,
        .tooltip,
        .popover {
            font-family: -apple-system, BlinkMacSystemFont, "Noto Sans KR", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }

        table th {
            font-weight: lighter;
        }

        a.underline:hover {
            text-decoration: underline !important;
        }

        p {
            margin:0 !important;
        }

        .fs-7 {
            font-size:0.85rem;
        }

        .fs-8 {
            font-size:0.75rem;
        }

        .round {
            border-radius: 50%;
        }

        .ol-none {
            outline:none !important;
            border:none !important;
        }

        #mainNav {
            position:fixed;
            top:0;
            left:0;
            right:0;
            z-index: 1;
            background-color: #fff;
        }

        .nav-item a {
            color:#000 !important;
        }

        .shadow-footer {
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        }

        .shadow-effect {
            transition:0.2s ease;
        }

        .shadow-effect:hover {
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        }

        .dropdown-toggle::after {
            display:none !important;
        }

        .blog-nav .nav-item {
            display:flex;
            justify-content:center;
            align-items:center;
            text-align:center;
        }

        .blog-nav .nav-item .nav-link {
            width:128px;
            height:48px;
            font-size:19px;
        }

        .blog-nav .nav-item .nav-link.active {
            color:#20c997 !important;
            border-bottom:2px solid #20c997;
        }

        .outline-none:focus,
        .outline-none:active {
            border: none !important;
            outline: none !important;
        }

        .tagify-outside {
            border:none !important;
        }

        .blank-line {
            background: rgb(73, 80, 87);
            height: 6px;
            width: 4rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 1px;
        }

        .fixed-bottom {
            position: fixed;
            bottom: 0;
            z-index:10;
        }

        .grid-1fr {
            grid-auto-columns: 1fr;
            grid-template-rows: 1fr;
        }

        .div-thumbnail {
            width:100%;
            height:190px;
            padding:1.4rem;
            background-color: #e5e8ec;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .vertical-line {
            width:1px;
            min-height: 425px;
            margin:0 2rem;
            padding:0 !important;
            background-color: #d0d0d5;
        }

        #viewer .toastui-editor-contents {
            font-size:16px;
        }

        .badge {
            --bs-badge-padding-y: 0.5rem !important;
            font-weight:200 !important;
        }

        .tag-list {
            position:absolute;
            top:0;
            left:-220px;
            width:180px;
        }

        .tag-list ul li {
            margin-bottom: 0.3rem;
        }

        .comment-content {
            line-height: 1.7;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .comment-reply {
            display:inline-flex;
            align-items: center;
            cursor: pointer;
        }
    </style>
</head>

<nav th:fragment="main-nav" id="mainNav" class="navbar navbar-expand-sm px-4 border border-bottom">
    <a class="navbar-brand d-flex align-items-center" th:href="@{/}">
        <h4 class="text-black mb-0">ihatethislovesong.</h4>
    </a>
    <div class="collapse navbar-collapse">
        <div class="me-auto"></div>
        <ul class="navbar-nav me-2">
            <li class="nav-item" sec:authorize="isAuthenticated()">
                <a class="nav-link" th:href="@{/}">
                    <i class="fa fa-bell-o" aria-hidden="true"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:href="@{/}">
                    <i class="fa fa-search" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
        <div class="me-3">
            <a sec:authorize="!isAuthenticated()" th:href="@{/login}" class="btn btn-dark fs-7">
                시작하기
            </a>
            <a sec:authorize="isAuthenticated()" th:href="@{/editor/write}" class="btn btn-dark fs-7 text-white">
                새 글 작성
            </a>
        </div>
        <div sec:authorize="isAuthenticated()" class="dropdown">
            <a class="dropdown-toggle d-block" href="#" data-bs-toggle="dropdown"
               style="width:37px; height:37px">
                <img class="w-100 h-100 round shadow-effect" th:src="${account?.profileImage}" alt="profile-image" />
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <li>
                    <span class="text-secondary fs-7 dropdown-item" th:text="${account?.userId}">사용자</span>
                </li>
                <li>
                    <a class="dropdown-item" th:href="@{'/blog/' + ${account?.id} + '/post'}">내 블로그</a>
                </li>
                <li>
                    <a class="dropdown-item" th:href="@{/profile}">내 정보 수정</a>
                </li>
                <li>
                    <form th:action="@{/logout}" method="post">
                        <button type="submit" class="dropdown-item" th:href="@{/logout}">로그아웃</button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="py-5 d-flex align-items-center" th:fragment="about">
    <img class="round" style="width: 180px; height:180px" th:src="${accountInfo?.profileImage}" alt="profile-image" />
    <div class="ms-3">
        <p class="fs-4 fw-bold mb-2" th:text="${accountInfo.userId}">아이디</p>
        <a class="fs-7 fw-light mb-4 text-primary" th:text="${accountInfo.url}" th:attr="href=${accountInfo.url}" target="_blank">url</a>
        <p class="fs-6 fw-light" th:text="${accountInfo.shortDescription}">자기소개</p>
    </div>
</div>

<div th:fragment="blog-menu (curMenu)">
    <ul class="nav justify-content-center blog-nav">
        <li class="nav-item">
            <a class="nav-link" th:classappend="${curMenu == 'post'} ? active"
               th:href="@{'/blog/' + ${accountInfo.id} + '/post'}">글</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" th:classappend="${curMenu == 'series'} ? active"
               th:href="@{'/blog/' + ${accountInfo.id} + '/series'}">시리즈</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" th:classappend="${curMenu == 'about'} ? active"
               th:href="@{'/blog/' + ${accountInfo.id} + '/about'}">소개</a>
        </li>
    </ul>
</div>

<script type="application/javascript" th:fragment="form-validation">
    (function () {
        'use strict';

        window.addEventListener('load', function () {
            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.getElementsByClassName('needs-validation');

            // Loop over them and prevent submission
            Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated')
                }, false)
            })
        }, false)
    }())
</script>

<script type="application/javascript" th:inline="javascript" th:fragment="ajax-csrf-header">
    $(function() {
        var csrfToken = /*[[${_csrf.token}]]*/ null;
        var csrfHeader = /*[[${_csrf.headerName}]]*/ null;
        $(document).ajaxSend(function (e, xhr, options) {
            xhr.setRequestHeader(csrfHeader, csrfToken);
        });
    });
</script>

<div th:fragment="date-time">
    <script src="/node_modules/moment/min/moment-with-locales.js"></script>
    <script type="application/javascript">
        $(function () {
            moment.locale('ko');
            $(".date-time").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").format('LLL');
            });
            $(".date").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").format('LL');
            });
            $(".weekday").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").format('dddd');
            });
            $(".time").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").format('LT');
            });
            $(".calendar").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").calendar();
            });
            $(".fromNow").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").fromNow();
            });
            $(".date-weekday-time").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").format('LLLL');
            });
        })
    </script>
</div>

<div th:fragment="change-time-ago">
    <script src="/node_modules/moment/min/moment-with-locales.js"></script>
    <script type="application/javascript">
        $(function() {
            let btList = document.querySelectorAll('.before-time');

            btList.forEach((el) => {
                let time = changeToDate($(el).html());
                $(el).html(time);
            })

            function changeToDate(datetime) {
                // 오늘 날짜
                let now = moment(new Date())
                // 오늘과의 시간 차이
                let duration = moment.duration(now.diff(datetime))
                // 변환
                // asSeconds 를 하면 오늘과의 시간차이를
                // 초단위로 float datatype 으로 보여준다 (3.82 이런식)
                let seconds = duration.asSeconds()
                let minute = duration.asMinutes()
                let hours = duration.asHours()
                let days = duration.asDays()
                let weeks = duration.asWeeks()
                let month = duration.asMonths()
                let year = duration.asYears()

                // 그래서 사용할 때는 parseInt 를 사용해 int 로 바꿔야 한다.
                if (minute < 1) {
                    // 1분 미만이면 초 단위로 보여주고,
                    return parseInt(seconds) + '초 전'
                } else if (hours < 1) {
                    // 1시간 미만이면 분 단위로 보여주고
                    return parseInt(minute) + '분 전'
                } else if (hours < 24) {
                    // 하루 미만이면 시간으로 보여주고
                    return parseInt(hours) + '시간 전'
                } else if (weeks < 1) {
                    // 일주일 미만이면 일 단위로 보여주고
                    return parseInt(days) + '일 전'
                } else if (month < 1) {
                    // 한 달 미만이면 주 단위로 보여주고
                    return parseInt(weeks) + '주 전'
                } else if (year < 1) {
                    // 1년 미만이면 달 단위로 보여주고
                    return parseInt(month) + '달 전'
                } else {
                    // 1년 이상이면 넌 단위로 보여주고
                    return parseInt(year) + '년 전'
                }
            }
        })
    </script>
</div>

<div class="d-grid" th:fragment="write-form (mode, action)">
    <form class="needs-validation d-grid" th:action="@{${action}}" method="post" th:object="${editorForm}" novalidate>
        <div style="margin-top:58px;">
            <div class="d-grid w-100 h-100">
                <div class="d-grid" style="grid-template-rows: 1fr 70px;">
                    <div class="p-4 h-100 d-grid" style="grid-template-rows: auto auto auto 1fr auto">
                        <div class="mb-1">
                            <input class="fs-1 fw-bold border-0 w-100 outline-none" th:field="*{title}"
                                   id="editTitle" type="text" placeholder="제목을 입력하세요" />
                        </div>
                        <div class="blank-line"></div>
                        <div class="mb-2">
                            <input th:if="${mode == 'new'}" class="tagify-outside w-100 outline-none" type="text" name="tags" th:field="*{tags}"
                                   id="tags" placeholder="태그를 입력하세요" />
                            <input th:if="${mode == 'mod'}" class="tagify-outside w-100 outline-none" type="text" name="tags" th:field="*{tags}"
                                   id="tags" placeholder="태그를 입력하세요" />
                        </div>
                        <div id="editor"></div>
                        <textarea id="mainText" hidden="hidden" th:field="*{mainText}"></textarea>
                    </div>
                    <div class="p-3 shadow-footer d-flex justify-content-between border-top">
                        <a href="javascript:window.history.back()" class="btn btn-light" style="width:180px">
                            나가기
                        </a>
                        <a id="publishedModalBtn" class="btn btn-dark"
                           data-bs-toggle="modal" data-bs-target="#publishedModal" style="width:180px">
                            출간하기
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="publishedModal" tabindex="-1" aria-hidden="true" style="--bs-modal-width:100%; --bs-modal-bg:#F8F9FA">
            <div class="modal-dialog d-grid grid-1fr w-100 h-100 m-0">
                <div class="modal-content" style="border-radius:0">
                    <div class="modal-body w-100 h-100">
                        <div class="d-flex align-items-center justify-content-center w-100 h-100">
                            <div class="d-flex" style="width:768px">
                                <section style="flex:1 1 0%">
                                    <div class="mb-4">
                                        <h5>포스트 미리보기</h5>
                                        <div id="thumbnailSettingWrap">
                                            <div class="d-flex justify-content-end mb-2">
                                                <label for="thumbnailReUpload" class="btn btn-light btn-sm me-2">재업로드</label>
                                                <input type="file" id="thumbnailReUpload" hidden />
                                                <button id="thumbnailDelete" class="btn btn-light btn-sm">제거</button>
                                            </div>
                                        </div>
                                        <div id="currentThumbnailImage" class="div-thumbnail rounded">
                                            <i class="fa fa-picture-o mb-3 fs-3" aria-hidden="true"></i>
                                            <label class="btn btn-light" for="thumbnailUpload">썸네일 업로드</label>
                                            <input type="file" id="thumbnailUpload" hidden />
                                        </div>
                                        <div id="newThumbnailImage"></div>
                                        <input type="text" id="thumbnailImage" hidden th:field="*{thumbnail}" />
                                    </div>
                                    <div>
                                        <h5>안녕하세요</h5>
                                        <textarea type="text" class="form-control" id="description" th:field="*{description}"
                                                  style="height:110px; font-size:14px;" placeholder="당신의 포스트를 짧게 소개해보세요." required></textarea>
                                    </div>
                                </section>
                                <div class="vertical-line"></div>
                                <section class="d-flex flex-column justify-content-between" style="flex:1 1 0%">
                                    <div>
                                        <div class="mb-4">
                                            <h5>공개 설정</h5>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" role="switch" id="disclosure" th:field="*{disclosure}">
                                                <label class="form-check-label" for="disclosure">포스팅 공개</label>
                                            </div>
                                        </div>
                                        <div class="mb-4">
                                            <h5>URL 설정</h5>
                                            <div class="d-flex w-100 rounded border" style="padding:0.7rem; background-color:#fff; align-items:center; font-size:14px">
                                                <span>/</span>
                                                <input id="url" class="ol-none w-100" type="text" th:field="*{url}" />
                                            </div>
                                            <small class="form-text text-danger" th:if="${#fields.hasErrors('url')}" th:errors="*{url}"></small>
                                        </div>
                                        <div class="mb-4">
                                            <h5>시리즈 설정</h5>
                                            <button class="btn btn-dark btn-block w-100 text-align-center" style="height:48px">
                                                <i class="fa fa-list" aria-hidden="true"></i> 시리즈 설정하기
                                            </button>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <a class="btn btn-light" data-bs-dismiss="modal" aria-label="Close" style="width:150px">취소</a>
                                        <button th:if="${mode == 'new'}" type="submit" id="publishedBtn" class="btn btn-dark" style="width:150px">출간하기</button>
                                        <button th:if="${mode == 'mod'}" type="submit" id="publishedBtn" class="btn btn-dark" style="width:150px">수정하기</button>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script th:fragment="write-script">
    $(function() {

        // *************** tagify js ***************
        let input = document.querySelector("#tags");
        new Tagify(input);
        // ******************************************

        const $newThumbnailImage = $('#newThumbnailImage');
        const $currentThumbnailImage = $('#currentThumbnailImage');
        const $thumbnailSettingWrap = $('#thumbnailSettingWrap');
        const $thumbnailDelete = $('#thumbnailDelete');

        let $thumbnailImage = $('#thumbnailImage');

        $newThumbnailImage.hide();
        $thumbnailSettingWrap.hide();

        $("#thumbnailUpload").change(function(e) {
            fn_imageReader(e);
        });

        $("#thumbnailReUpload").change(function(e) {
            fn_imageReader(e);
        })

        $($thumbnailDelete).click(function() {
            $newThumbnailImage.hide();
            $thumbnailSettingWrap.hide();
            $currentThumbnailImage.show();
        })

        if($thumbnailImage[0].value.length > 0) {
            let img = document.createElement("img");
            img.id = 'new-thumbnail';
            img.src = $thumbnailImage[0].value;
            img.className = 'rounded';
            img.setAttribute('width', '100%');

            $newThumbnailImage.html(img);
            $newThumbnailImage.show();
            $currentThumbnailImage.hide();
            $thumbnailSettingWrap.show();
        }

        function fn_imageReader(e) {
            if (e.target.files.length === 1) {
                const reader = new FileReader();
                reader.onload = e => {
                    if (e.target.result) {
                        if (!e.target.result.startsWith("data:image")) {
                            alert("이미지 파일을 선택하세요.");
                            return;
                        }

                        let img = document.createElement("img");
                        img.id = 'new-thumbnail';
                        img.src = e.target.result;
                        img.className = 'rounded';
                        img.setAttribute('width', '100%');

                        $newThumbnailImage.html(img);
                        $newThumbnailImage.show();
                        $currentThumbnailImage.hide();
                        $thumbnailSettingWrap.show();

                        $thumbnailImage.val(reader.result);
                    }
                }

                reader.readAsDataURL(e.target.files[0]);
            }
        }
    })
</script>

</html>